<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Clasico Team Manager</title>

    <!-- React, ReactDOM, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (via CDN - Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- CSS Incorporato (con aggiunta per toggle live) -->
    <style>
        /* ... (stili precedenti invariati) ... */

        /* File IO Section & Live Sync Toggle */
        .file-io-section { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; }
        .db-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; margin-bottom: 15px;}
        .live-sync-toggle { display: flex; align-items: center; gap: 8px; padding: 10px; background-color: #e9ecef; border-radius: 5px; margin-bottom: 15px; justify-content: center; }
        .live-sync-toggle input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
        .live-sync-toggle label { margin: 0; font-weight: bold; cursor: pointer; }
        .status-indicator { font-size: 0.9em; color: #6c757d; flex-basis: 100%; text-align: center; margin-top: 5px;}
        .status-indicator .mode-local { color: #5a6268; font-weight: bold; }
        .status-indicator .mode-live { color: #dc3545; font-weight: bold; }
        .db-status-message { font-size: 0.9em; font-style: italic; color: #17a2b8; margin-left: 10px; display: block; text-align: center; margin-top:5px; }

         /* Responsive per controlli DB */
         @media (max-width: 768px) {
            .db-controls { flex-direction: column; align-items: stretch; }
            .db-controls button { width: 100%; margin-bottom: 5px; }
         }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">

        // === Hook e Costanti ===
        const { useState, useEffect, useCallback, useRef } = React;
        const ALL_ROLES = ['Portiere', 'Difensore', 'Centrocampista', 'Attaccante'];
        const SAVE_PASSWORD = "RoyClasico";
        const MASTER_COLLECTION_NAME = 'giocatori_master'; // Collezione storica/ufficiale
        const LIVE_COLLECTION_NAME = 'giocatori_live';     // Collezione per sync real-time

        // --- Hook useLocalStorage (Invariato) ---
        function useLocalStorage(key, initialValue) { /* ... codice invariato ... */ }

        // --- Inizializzazione Firebase ---
        const firebaseConfig = { /* ... tua config ... */ };

        let db;
        let masterPlayersCollectionRef;
        let livePlayersCollectionRef; // NUOVO: Ref per collezione live
        let firebaseInitializationError = null;

        try {
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            else { firebase.app(); }
            db = firebase.firestore();
            masterPlayersCollectionRef = db.collection(MASTER_COLLECTION_NAME);
            livePlayersCollectionRef = db.collection(LIVE_COLLECTION_NAME); // NUOVO
            console.log(`Riferimenti Firestore: OK ('${MASTER_COLLECTION_NAME}', '${LIVE_COLLECTION_NAME}')`);
        } catch (error) {
             console.error("!!! ERRORE CRITICO FIREBASE !!!", error);
             firebaseInitializationError = `Errore grave inizializzazione DB (${error.message}).`;
        }
        // --- Fine Inizializzazione Firebase ---

        // === Funzioni Utili (Invariate) ===
        const calculatePlayerScore = (player) => { /*...*/ };
        const getRequiredPlayers = (matchType) => { /*...*/ };
        const calculateTeamFinalScore = (team) => { /*...*/ };
        const roleOrder = ['Portiere', 'Difensore', 'Centrocampista', 'Attaccante'];
        const getAvgScore = (player) => { /*...*/ };
        const balanceTeams = (players, unpredictability, balanceByRole) => { /*...*/ };
        function drawFormation(canvas, teamA, teamB, matchType) { /*...*/ };

        // === Componenti React (Struttura JSX invariata, ma logica interna cambia) ===
        function PlayerForm({ onSave, editingPlayer, onCancelEdit, currentMode }) {
            // ... (logica interna e stato del form invariati) ...
            // Potremmo cambiare il testo del bottone "Salva" in base alla modalità, ma per ora lo lasciamo generico
            const buttonText = editingPlayer ? 'Salva Modifiche' : 'Aggiungi Giocatore';
             return (
                 <div className="player-form-container">
                    {/* ... (pulsante toggle e form JSX) ... */}
                     {/* Nota: Il bottone submit chiama onSave, che ora ha logica condizionale */}
                     <div className="form-actions">
                         <button type="submit" className="btn-save">{buttonText} ({currentMode === 'live' ? 'Live' : 'Locale'})</button>
                         <button type="button" onClick={handleCancel} className="btn-cancel">Annulla</button>
                     </div>
                 {/* ... (chiusura form) ... */}
                 </div>
             );
        }
        function PlayerItem({ player, onEdit, onDelete, currentMode }) {
            const avgScore = getAvgScore(player);
            // Aggiungiamo un piccolo indicatore se l'ID è locale
            const isLocalOnly = player.id && player.id.startsWith('local_');
             return (
                 <li className="player-item">
                     <div className="player-info">
                         {player.photoUrl ? (<img src={player.photoUrl} alt={player.nome} className="player-photo-thumbnail" />) : (<span className="player-photo-thumbnail"></span>)}
                         <div className="player-details">
                             <span className="player-name">{player.nome} {isLocalOnly && <small>(Locale)</small>}</span>
                             <span className="player-meta"><span className="player-role">{player.ruolo}</span><span className="player-avg-score">Avg: {avgScore}</span></span>
                         </div>
                     </div>
                     {/* Le azioni ora chiamano handler che dipendono dalla modalità */}
                     <div className="player-actions">
                        <button onClick={() => onEdit(player.id)} className="btn-edit">Modifica</button>
                        <button onClick={() => onDelete(player.id)} className="btn-delete">Elimina ({currentMode === 'live' ? 'Live!' : 'Loc.'})</button>
                    </div>
                 </li>
             );
        }
        function PlayerList({ players, onEdit, onDelete, currentMode }) {
             const listTitle = currentMode === 'live' ? `Giocatori Condivisi Live (${players.length})` : `Giocatori Locali (${players.length})`;
             const emptyListMessage = currentMode === 'live'
                ? "Nessun giocatore nella sessione live condivisa. Aggiungine uno per iniziare!"
                : "Nessun giocatore nella lista locale. Carica da DB Master, attiva Sync Live o aggiungine di nuovi.";

             return (
                 <div className="player-list-container">
                     <h2>{listTitle}</h2>
                     {players.length === 0 ? (<p>{emptyListMessage}</p>) : (
                        <ul className="player-list">
                            {players.map(p => (<PlayerItem key={p.id} player={p} onEdit={onEdit} onDelete={onDelete} currentMode={currentMode}/>))}
                        </ul>
                     )}
                 </div>
             );
        }
        // PlayerSelectionModal, MatchSetup, TeamDisplay: JSX sostanzialmente invariato,
        // ma operano sempre sui 'players' correnti passati come prop.

        function PlayerSelectionModal({ players, selectedPlayerIds, requiredCount, onToggleSelect, onConfirm, onClose }) { /* ... codice JSX invariato ... */ }
        function MatchSetup({ matchType, onMatchTypeChange, onOpenSelection, availablePlayerCount }) { /* ... codice JSX invariato ... */ }
        function TeamDisplay({ players, selectedPlayerIds, teams, matchType, onUpdateTeams, onClearSelection, balanceByRoleEnabled, onToggleBalanceByRole, onGenerateTeams }) { /* ... codice JSX invariato ... */ }


        // === Componente Principale App ===
        function App() {
            // STATO PRINCIPALE
            const [players, setPlayers] = useState([]); // Lista giocatori attiva (locale o live)
            const [operatingMode, setOperatingMode] = useState('local'); // 'local' o 'live'
            const listenerUnsubscribeRef = useRef(null); // Per staccare il listener di Firestore

            // Stati UI e Feedback
            const [editingPlayer, setEditingPlayer] = useState(null);
            const [selectedPlayerIds, setSelectedPlayerIds] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const fileInputRef = useRef(null);
            const [isDbLoading, setIsLoadingDb] = useState(false); // Per operazioni DB (master load, live connect)
            const [isDbSaving, setIsSavingDb] = useState(false);   // Per salvataggio DB Master
            const [dbStatusMessage, setDbStatusMessage] = useState('');
            const [dbError, setDbError] = useState(firebaseInitializationError);

            // Stati salvati in localStorage (invariati)
            const [matchType, setMatchType] = useLocalStorage('calcettoMatchType_1', null);
            const [teams, setTeams] = useLocalStorage('calcettoTeamsV6_1', { teamA: [], teamB: [] });
            const [balanceByRoleEnabled, setBalanceByRoleEnabled] = useLocalStorage('calcettoBalanceByRole_1', true);

            // --- Funzione Pulizia Stato Dipendente ---
            const clearDependentState = () => {
                setSelectedPlayerIds([]);
                setTeams({ teamA: [], teamB: [] });
                setEditingPlayer(null);
                setMatchType(null); // Resettiamo anche il tipo partita
                 // Non resettare balanceByRoleEnabled
            };

            // --- Gestione Listener Live ---
            const setupLiveListener = () => {
                if (!livePlayersCollectionRef || listenerUnsubscribeRef.current) return; // Già attivo o errore
                console.log("Attivazione listener su", LIVE_COLLECTION_NAME);
                setIsLoadingDb(true); // Mostra caricamento durante la connessione iniziale
                setDbStatusMessage("Connessione alla sessione Live...");

                listenerUnsubscribeRef.current = livePlayersCollectionRef.onSnapshot(snapshot => {
                    console.log("Dati ricevuti da Firestore (LIVE):", snapshot.size);
                    const livePlayersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPlayers(livePlayersData); // Aggiorna lo stato locale con i dati live
                    setIsLoadingDb(false); // Caricamento completato (o aggiornamento ricevuto)
                    setDbStatusMessage(""); // Pulisci messaggio connessione
                    setDbError(null);

                    // Se la lista live cambia, dobbiamo invalidare le selezioni/squadre locali
                    // Potremmo cercare di preservarle se gli ID esistono ancora, ma è più semplice resettare
                    clearDependentState();

                }, error => {
                    console.error("Errore listener Firestore LIVE:", error);
                    setDbError(`Errore connessione Live: ${error.message}. Disattivazione.`);
                    setDbStatusMessage(`Errore Live: ${error.message}`);
                    setIsLoadingDb(false);
                    // Errore grave, disattiviamo la modalità live
                    setOperatingMode('local');
                    setPlayers([]); // Svuota la lista locale
                    if (listenerUnsubscribeRef.current) {
                        listenerUnsubscribeRef.current();
                        listenerUnsubscribeRef.current = null;
                    }
                     clearDependentState();
                });
            };

            const detachLiveListener = () => {
                if (listenerUnsubscribeRef.current) {
                    console.log("Disattivazione listener Live.");
                    listenerUnsubscribeRef.current();
                    listenerUnsubscribeRef.current = null;
                }
                 // Reset stato quando si esce da Live
                 setPlayers([]); // Lista vuota in modalità locale
                 clearDependentState();
                 setDbStatusMessage(""); // Pulisci eventuali messaggi
            };

            // Effetto per gestire il cleanup del listener quando il componente smonta
            useEffect(() => {
                return () => {
                    detachLiveListener(); // Assicura che il listener sia staccato
                };
            }, []); // Esegui solo al mount/unmount

            // --- Handler Toggle Sincronizzazione Live ---
            const handleToggleLiveSync = (event) => {
                const isEnabling = event.target.checked;

                if (isEnabling) {
                    if (window.confirm("Attivare la Sincronizzazione Live?\nLa lista locale attuale e le squadre verranno perse e vedrai la lista condivisa.")) {
                        detachLiveListener(); // Assicura che non ci siano listener precedenti appesi
                        setOperatingMode('live');
                        // setupLiveListener() verrà chiamato dall'effetto sotto
                    } else {
                         event.target.checked = false; // Riporta la checkbox allo stato precedente
                    }
                } else {
                     if (window.confirm("Disattivare la Sincronizzazione Live?\nVerrai disconnesso e tornerai a una lista locale vuota.")) {
                        setOperatingMode('local');
                        // detachLiveListener() verrà chiamato dall'effetto sotto
                    } else {
                         event.target.checked = true; // Riporta la checkbox allo stato precedente
                    }
                }
            };

             // Effetto per attaccare/staccare il listener quando operatingMode cambia
             useEffect(() => {
                if (operatingMode === 'live') {
                    setupLiveListener();
                } else {
                    detachLiveListener();
                }
                 // Funzione di cleanup per questo effetto specifico
                return () => {
                    detachLiveListener();
                };
            }, [operatingMode]); // Riesegui quando operatingMode cambia


            // --- Handlers CRUD (Aggiungi/Modifica/Elimina Giocatore) ---
            // Ora dipendono da operatingMode
            const handleSavePlayer = async (playerData) => {
                const { id, ...dataToSave } = playerData;
                 if (!dataToSave.photoUrl) { delete dataToSave.photoUrl; } // Pulisci foto

                if (operatingMode === 'live') {
                    // --- SALVATAGGIO LIVE SU FIRESTORE ---
                    if (!livePlayersCollectionRef) { alert("Errore: DB Live non connesso."); return; }
                    setDbStatusMessage("Salvataggio Live in corso...");
                    try {
                        if (id && !id.startsWith('local_')) { // Modifica giocatore esistente nel DB Live
                            await livePlayersCollectionRef.doc(id).update(dataToSave);
                            setDbStatusMessage("Giocatore modificato (Live).");
                        } else { // Aggiunta nuovo giocatore al DB Live (Firestore genera ID)
                            await livePlayersCollectionRef.add(dataToSave);
                            setDbStatusMessage("Giocatore aggiunto (Live).");
                        }
                        setEditingPlayer(null); // Chiudi form
                    } catch (error) {
                        console.error("Errore salvataggio Live:", error);
                        alert(`Errore salvataggio Live: ${error.message}`);
                        setDbStatusMessage(`Errore salvataggio Live: ${error.message}`);
                    } finally {
                         setTimeout(() => setDbStatusMessage(''), 3000);
                         // Il listener aggiornerà automaticamente lo stato `players`
                    }

                } else {
                    // --- SALVATAGGIO LOCALE ---
                    if (id) { // Modifica locale
                        setPlayers(prev => prev.map(p => p.id === id ? { ...p, ...dataToSave, id: id } : p));
                        setDbStatusMessage('Giocatore modificato (Locale).');
                    } else { // Aggiunta locale
                        const newPlayer = { ...dataToSave, id: `local_${crypto.randomUUID()}` };
                        setPlayers(prev => [...prev, newPlayer]);
                        setDbStatusMessage('Giocatore aggiunto (Locale).');
                    }
                    setEditingPlayer(null);
                    setTimeout(() => setDbStatusMessage(''), 3000);
                }
            };

            const handleDeletePlayer = async (playerId) => {
                 const playerToDelete = players.find(p => p.id === playerId);
                 if (!playerToDelete) return;

                if (operatingMode === 'live') {
                    // --- ELIMINAZIONE LIVE DA FIRESTORE ---
                    if (!livePlayersCollectionRef) { alert("Errore: DB Live non connesso."); return; }
                    if (playerId.startsWith('local_')) {
                         alert("Errore: Non puoi eliminare un giocatore locale mentre sei in modalità Live."); return;
                    }
                    if (window.confirm(`Eliminare ${playerToDelete.nome} dalla sessione Live condivisa?\n(L'azione è immediata per tutti)`)) {
                        setDbStatusMessage("Eliminazione Live in corso...");
                        try {
                            await livePlayersCollectionRef.doc(playerId).delete();
                            setDbStatusMessage("Giocatore eliminato (Live).");
                             // Non serve pulire stato locale, il listener lo farà
                            if (editingPlayer?.id === playerId) setEditingPlayer(null);
                        } catch(error) {
                            console.error("Errore eliminazione Live:", error);
                            alert(`Errore eliminazione Live: ${error.message}`);
                            setDbStatusMessage(`Errore eliminazione Live: ${error.message}`);
                        } finally {
                            setTimeout(() => setDbStatusMessage(''), 3000);
                        }
                    }
                } else {
                     // --- ELIMINAZIONE LOCALE ---
                     if (window.confirm(`Eliminare ${playerToDelete.nome} dalla lista locale?`)) {
                        setPlayers(prev => prev.filter(p => p.id !== playerId));
                        // Pulisci dipendenze locali
                        setSelectedPlayerIds(prev => prev.filter(id => id !== playerId));
                        setTeams(prev => ({ teamA: prev.teamA.filter(p => p.id !== playerId), teamB: prev.teamB.filter(p => p.id !== playerId) }));
                        if (editingPlayer?.id === playerId) setEditingPlayer(null);
                        setDbStatusMessage('Giocatore eliminato (Locale).');
                        setTimeout(() => setDbStatusMessage(''), 3000);
                    }
                }
            };

            const handleEditPlayer = (playerId) => {
                const playerToEdit = players.find(p => p.id === playerId);
                 if (playerToEdit) { setEditingPlayer(playerToEdit); window.scrollTo({ top: 0, behavior: 'smooth' }); }
            };
            const handleCancelEdit = () => { setEditingPlayer(null); };
            // --- Fine Handlers CRUD ---


            // --- Handlers DB MASTER (Carica/Salva) ---
            const handleLoadFromFirestoreMaster = async () => {
                if (!masterPlayersCollectionRef) { alert("Errore: DB Master non connesso."); return; }
                if (window.confirm(`Caricare la lista giocatori dal DB Master (${MASTER_COLLECTION_NAME})?\nQuesto SOVRASCRIVERÀ la lista attuale e disattiverà la Sync Live (se attiva).`)) {

                    // PRIMA disattiva la modalità live, se attiva
                    if (operatingMode === 'live') {
                         setOperatingMode('local'); // Questo triggera useEffect per staccare il listener
                         // Aspetta un attimo per assicurare che il detach avvenga prima di procedere
                         await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    setIsLoadingDb(true);
                    setDbStatusMessage(`Caricamento da DB Master (${MASTER_COLLECTION_NAME})...`);
                    setDbError(null);
                    try {
                        const snapshot = await masterPlayersCollectionRef.get();
                        const masterPlayersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setPlayers(masterPlayersData); // Sovrascrivi stato locale
                        clearDependentState();
                        setDbStatusMessage(`Caricati ${masterPlayersData.length} giocatori dal DB Master.`);
                    } catch (error) {
                        console.error("Errore caricamento DB Master:", error);
                        setDbError(`Errore caricamento DB Master: ${error.message}.`);
                        setDbStatusMessage(`Errore caricamento DB Master: ${error.message}`);
                    } finally {
                        setIsLoadingDb(false);
                        setTimeout(() => setDbStatusMessage(''), 5000);
                    }
                }
            };

            const handleSaveToFirestoreMaster = async () => {
                 if (!masterPlayersCollectionRef) { alert("Errore: DB Master non connesso."); return; }
                 const password = window.prompt(`Inserisci la password per SALVARE sul DB Master (${MASTER_COLLECTION_NAME}):`);
                 if (password === null) return;
                 if (password !== SAVE_PASSWORD) { alert("Password errata!"); return; }
                 if (!window.confirm(`ATTENZIONE!\nSOVRASCRIVERE l'intero DB Master (${MASTER_COLLECTION_NAME}) con i ${players.length} giocatori attualmente visualizzati (locali o live)?\nAzione IRREVERSIBILE.`)) return;

                 setIsSavingDb(true);
                 setDbStatusMessage(`Salvataggio su DB Master (${MASTER_COLLECTION_NAME})...`);
                 setDbError(null);
                 try {
                     const batch = db.batch();
                     const snapshot = await masterPlayersCollectionRef.get();
                     snapshot.docs.forEach(doc => batch.delete(doc.ref)); // Elimina vecchi

                     // Aggiungi quelli correnti (dallo stato 'players')
                     players.forEach(player => {
                         const { id, ...playerData } = player;
                         if (!playerData.photoUrl) delete playerData.photoUrl;
                         // Se l'ID è 'local_', lascia che Firestore generi un ID nuovo nel DB Master
                         const docRef = id && !id.startsWith('local_')
                            ? masterPlayersCollectionRef.doc(id)
                            : masterPlayersCollectionRef.doc();
                         batch.set(docRef, playerData);
                     });

                     await batch.commit();
                     setDbStatusMessage(`DB Master (${MASTER_COLLECTION_NAME}) sovrascritto con ${players.length} giocatori.`);
                     // Potresti voler ricaricare da Master per ottenere ID corretti se hai salvato giocatori 'local_'
                 } catch (error) {
                     console.error("Errore salvataggio DB Master:", error);
                     setDbError(`Errore salvataggio DB Master: ${error.message}.`);
                     setDbStatusMessage(`Errore salvataggio DB Master: ${error.message}`);
                 } finally {
                     setIsSavingDb(false);
                     // setTimeout(() => setDbStatusMessage(''), 8000);
                 }
            };
            // --- Fine Handlers DB Master ---


            // --- Handlers Partita/Selezione/Squadre (Invariati, operano su 'players' attuale) ---
            const handleMatchTypeChange = (type) => { /*...*/ };
            const handleOpenSelectionModal = () => setIsModalOpen(true);
            const handleCloseSelectionModal = () => setIsModalOpen(false);
            const handleTogglePlayerSelection = (playerId) => { /*...*/ };
            const handleConfirmSelection = () => { /*...*/ };
            const handleClearSelectionAndTeams = () => { /*...*/ };
            const handleToggleBalanceByRole = () => { /*...*/ };
            const handleUpdateTeams = useCallback((newTeams) => { /*...*/ }, [setTeams]);
            const handleGenerateBalancedTeams = useCallback((playersToBalance, unpredictability, balanceByRole) => { /*...*/ }, [setTeams]);
            // --- Fine Handlers Partita/Selezione/Squadre ---

            // --- Handlers File IO (Snapshot Locale - Invariati, operano su 'players' attuale) ---
            const handleSaveToFile = () => { /*...*/ };
            const handleLoadTrigger = () => { /*...*/ };
            const handleFileSelected = (event) => { /*...*/ };
            // --- Fine Handlers File IO ---

            // --- Render App ---
            const disableDbActions = isDbLoading || isDbSaving || !!firebaseInitializationError;
            const isLive = operatingMode === 'live';

            return (
                <div className="container">
                     <h1>El Clasico Team Manager <small>({isLive ? `Live Sync Attiva - DB: ${LIVE_COLLECTION_NAME}` : `Modalità Locale`})</small></h1>

                    {/* Messaggi Stato/Errore */}
                    {dbError && <div className="error-message">{dbError}</div>}
                    {(isDbLoading || isDbSaving) && <div className="loading-message">Operazione Database in corso...</div>}
                    {dbStatusMessage && !isDbLoading && !isDbSaving && <div className="db-status-message">{dbStatusMessage}</div>}


                    {!firebaseInitializationError && (
                        <>
                            <section id="gestione-giocatori">
                                <h2>Gestione Giocatori</h2>

                                <div className="file-io-section">
                                     {/* Toggle Live Sync */}
                                     <div className="live-sync-toggle">
                                        <input
                                            type="checkbox"
                                            id="liveSyncCheck"
                                            checked={isLive}
                                            onChange={handleToggleLiveSync}
                                            disabled={isDbLoading || isDbSaving}
                                        />
                                        <label htmlFor="liveSyncCheck">Attiva Sincronizzazione Live</label>
                                    </div>

                                    {/* Controlli DB e Snapshot */}
                                    <div className="db-controls">
                                        <button onClick={handleLoadFromFirestoreMaster} className="btn-load-db" disabled={disableDbActions} title={`Carica da DB Master (${MASTER_COLLECTION_NAME})`}>
                                            Carica da DB Master
                                        </button>
                                        <button onClick={handleSaveToFirestoreMaster} className="btn-save-db" disabled={disableDbActions || players.length === 0} title={`Salva su DB Master (${MASTER_COLLECTION_NAME}) (PW)`}>
                                            Salva su DB Master
                                        </button>
                                        <button onClick={handleSaveToFile} className="btn-save-file" disabled={disableDbActions || players.length === 0} title="Salva Snapshot Locale">Salva Snapshot</button>
                                        <button onClick={handleLoadTrigger} className="btn-load-file" disabled={disableDbActions} title="Carica Snapshot Locale">Carica Locale</button>
                                        <input ref={fileInputRef} type="file" accept=".json" style={{ display: 'none' }} onChange={handleFileSelected} />
                                    </div>

                                     <div className="status-indicator">
                                        Modalità: {isLive ? <span className="mode-live">LIVE SYNC</span> : <span className="mode-local">LOCALE</span>}
                                        {isLive && <span> (Modifiche condivise su <i>{LIVE_COLLECTION_NAME}</i>)</span>}
                                        {!isLive && <span> (Modifiche solo locali, usa i bottoni DB per sincronizzare con Master)</span>}
                                    </div>
                                </div>

                               {/* Form e Lista */}
                               <PlayerForm onSave={handleSavePlayer} editingPlayer={editingPlayer} onCancelEdit={handleCancelEdit} currentMode={operatingMode}/>
                               <PlayerList players={players} onEdit={handleEditPlayer} onDelete={handleDeletePlayer} currentMode={operatingMode}/>

                            </section>

                            <hr className="section-divider" />

                            {/* Sezioni Partita e Squadre (operano sui players correnti) */}
                            <section id="imposta-partita">
                                <MatchSetup matchType={matchType} onMatchTypeChange={handleMatchTypeChange} onOpenSelection={handleOpenSelectionModal} availablePlayerCount={players.length}/>
                            </section>

                            {isModalOpen && ( <PlayerSelectionModal players={players} selectedPlayerIds={selectedPlayerIds} requiredCount={getRequiredPlayers(matchType)} onToggleSelect={handleTogglePlayerSelection} onConfirm={handleConfirmSelection} onClose={handleCloseSelectionModal} /> )}

                            <hr className="section-divider" />

                            <section id="crea-squadre">
                                <TeamDisplay players={players} selectedPlayerIds={selectedPlayerIds} teams={teams} matchType={matchType} onUpdateTeams={handleUpdateTeams} onClearSelection={handleClearSelectionAndTeams} balanceByRoleEnabled={balanceByRoleEnabled} onToggleBalanceByRole={handleToggleBalanceByRole} onGenerateTeams={handleGenerateBalancedTeams} />
                            </section>
                        </>
                    )}
                </div>
            );
        } // --- Fine App ---


        // === Monta l'App React nel DOM con Error Boundary (Invariato) ===
        const rootElement = document.getElementById('root');
        if (rootElement) {
            try {
                 const root = ReactDOM.createRoot(rootElement);
                 class ErrorBoundary extends React.Component { /* ... */ }
                 root.render(<ErrorBoundary><App /></ErrorBoundary>);
            } catch (error) { /* ... */ }
        } else { /* ... */ }

    </script>

</body>
</html>
